---
layout: post
title: üì¶ AutoPkg and Trust
---
<p>A couple of <a href="https://macadmins.slack.com/archives/C056155B4/p1716063575198279" target="_blank">recent</a> <a href="https://macadmins.slack.com/archives/C056155B4/p1717775362650079" target="_blank">discussions</a> in the #autopkg channel of the Mac Admins Slack got me thinking more deeply about trust in AutoPkg. Trust Verification was adopted in late 2016 with Version 1.0 of AutoPkg.<a href="#foot1" id="ref1"><sup>[1]</sup></a> As of that version, all recipe overrides track the non-core processors and parent recipes that the override uses, such that changes to any of those will trigger a trust warning (and, if you have strict trust verification turned on, the recipe will not run until trust is re-established). The <a href="https://github.com/autopkg/autopkg/wiki/AutoPkg-and-recipe-parent-trust-info" target="_blank">AutoPkg wiki describes this in more detail</a>.</p>
<p>But that doesn‚Äôt cover everything that an Admin has to ‚Äútrust‚Äù when running AutoPkg. So I thought it would be worthwhile to lay that out clearly for both the novice and more experienced user. I‚Äôm going to start with a chart that summarizes this and then describe what it all means.</p>
<h3>The Trust Table</h3>
<table>
	<thead>
	<tr> <th width=50%>Item to Run</th>	<th>Maintainer<br />Scrutiny</th>	<th>Trust<br />Verification</th> </tr>
	</thead>
	<tbody>
	<tr> <td>AutoPkg Code (including core processors)</td>	<td>Strong</td>	<td>No</td> </tr>
	<tr> <td>Core recipes</td>	<td>Strong</td>	<td>Yes</td> </tr>
	<tr> <td>Custom processors in Core recipes repo</td>	<td>Strong</td>	<td>Yes</td> </tr>
	<tr> <td>AutoPkg Org recipe repos</td>	<td>Minimal</td>	<td>Yes</td> </tr>
	<tr> <td>Custom processors in Org recipe repos</td>	<td>Minimal</td>	<td>Yes*</td> </tr>
	<tr> <td>Recipe repos from other sources</td>	<td>None</td>	<td>Yes</td> </tr>
	<tr> <td>Custom processors from other sources</td>	<td>None</td>	<td>Yes*</td> </tr>
	<tr> <td>Recipes that you wrote</td>	<td>(Your Own)</td>	<td>Yes</td> </tr>
	<tr> <td>Processors that you wrote</td>	<td>(Your Own)</td>	<td>Yes*</td> </tr>
	<tr> <td>Any recipe run with strict trust verification set to False (or not set)</td>	<td>See above</td>	<td>No</td> </tr>
	<tr> <td>Any processor run as a pre- or postprocessor or from an override</td>	<td>See above</td>	<td>No</td> </tr>
	<tr> <td colspan=3>* Any Python shared library loaded by these processors is not subject to Trust Verification.</td></tr>
	</tbody>
</table>
<p>In this table, ‚ÄúMaintainer Scrutiny‚Äù refers to how much oversight the item has seen from the AutoPkg Maintainers. ‚ÄúTrust Verification‚Äù refers to the automated process introduced in AutoPkg 1.0, referenced above.</p>
<h3>It‚Äôs Trust <em>Verification</em>, Not <em>Trust</em></h3>
<p>Naming what AutoPkg does programatically as ‚Äútrust verification‚Äù is no accident. Initial trust of a recipe/workflow is established by <em>you,</em> the Admin. It is assumed that, before you run any AutoPkg recipe in production, you will check that the recipe chain/AutoPkg command that you will run will do what you need it to do, without doing any damage (e.g., to your AutoPkg host). There are many ways to do this and you can use multiple ways (e.g., using the <code>audit</code> verb, reading the plist/YAML markup to determine what it does, testing the recipe in a disposable environment like a VM). Once you have confirmed that all is well, that is when trust <em>verification</em> becomes relevant, as that feature checks for changes from a trusted state.</p>
<p>The Maintainer Scrutiny column in the table above suggests how deliberate you might want to be in that initial testing based on how much scrutiny the recipes and/or processors have already gone through. The core processors and recipes have been scrutinized by one or more of the AutoPkg project maintainers and any future change made will receive the same, high level of scrutiny.</p>
<p>Once you start using the recipes and processors of others (as almost all of us do), the question of scrutiny becomes less clear. If the repo is in the AutoPkg org (i.e., github.org/autopkg/<cite>username</cite>-recipes), the repo may have been looked at when it was initially added to the org and the maintainers will occasionally examine recipes and processors for common errors (usually in an automated way), but that‚Äôs fairly minimal.</p>
<p>The phrase ‚ÄúConsider the source‚Äù comes to mind here. Some business enterprises have spent a lot of time on their repos and need them to work well for their customer base, so one might consider the recipes and processors from, for example, dataJAR-recipes (in the autopkg org) and KAPPA (in the kandji-inc org) as being fairly trustworthy, even though they may have had little or no scrutiny from the AutoPkg Maintainers. Likewise, running recipes written by you or someone you know personally is another kind of implicit trust that may affect what level of testing you do. Regardless, most of us load Git repos into AutoPkg, so have a plan on how you will test new additions to your AutoPkg setup.</p>
<p>One final caveat: Processors are Python code running as root. Even well-trusted processors can do damage when fed particular options (the core <code>PathDeleter</code> processor comes to mind). Establishing an initial trusted state is important.</p>
<h3>What Trust Verification Does and Doesn‚Äôt Do</h3>
<p>Once you establish that initial trusted state, there are three things that may need to change over time in order for your workflow to continue to work:
<ol><li>AutoPkg code (including core processors),</li>
<li>Recipes, and</li>
<li>Custom/Shared Processors.</li>
</ol></p>
<p>Changes to <code>/Library/AutoPkg</code> (where the AutoPkg code and core processors are stored) are not captured by Trust Verification.<a href="#foot2" id="ref2"><sup>[2]</sup></a> For example, if you just updated to version 2.7.3 of AutoPkg, one of the core processors was updated and no updates were required to your overrides. Nevertheless, you are still responsible for testing the update just like you test any other software release. The Release Notes are a great help in determining what you should be inspecting, as they tend to be fairly thorough.</p>
<p>Recipe and custom/shared processor changes mostly fall under the Trust Verification model built in to AutoPkg. If you update a recipe or custom/shared processor, whether that is by updating the repo that has the changed item(s) in it, or by manually editing the item yourself (as you might for a recipe that you wrote and don‚Äôt have in a Git repo), trust verification will catch that change at runtime if you are running an override.<a href="#foot3" id="ref3"><sup>[3]</sup></a> You still need to inspect the changes to verify that you still trust these recipes and/or processors, then update the trust in the override to reset the Trust Verification for that recipe.<a href="#foot4" id="ref4"><sup>[4]</sup></a></p>
<p>There are two things to take note of with the Trust Verification model:</p>
<ul><li>The Trust Verification feature is <em>not set</em> by default ‚Äî you will only get a warning at runtime and you won‚Äôt even see <em>that</em> if you only use <a href="https://github.com/lindegroup/autopkgr" target="_blank">AutoPkgr</a>. So unless you have <a href="https://macadmins.slack.com/archives/C056155B4/p1717777245489819?thread_ts=1717775362.650079&cid=C056155B4" target="_blank">a different method to deal with recipe trust</a>, you should set this preference (<code>defaults write com.github.autopkg FAIL_RECIPES_WITHOUT_TRUST_INFO -bool YES</code>) as one of the first things you do when setting up AutoPkg. Helpfully, if you use Graham Pugh‚Äôs <a href="https://github.com/grahampugh/AutoPkgSetup" target="_blank">AutoPkgSetup shell script</a> to install and setup AutoPkg, it will set that value automatically (unless you specify otherwise).</li>
<li>Most custom/shared processors only load ‚Äúexternal‚Äù code from AutoPkg itself (e.g., <code>from autopkglib import ProcessorError</code>), but it is certainly possible to load other Python modules. Currently, the processors that integrate  <a href="https://github.com/grahampugh/jamf-upload" target="_blank">Jamf Pro</a>, <a href="https://github.com/almenscorner/IntuneUploader" target="_blank">Intune</a>, and <a href="https://github.com/kandji-inc/KAPPA" target="_blank">Kandji</a> have their own custom library/libraries to provide ‚Äúbase‚Äù code for their suite of processors. These are loaded by the processors themselves (e.g., <code>from JamfUploaderBase import JamfUploaderBase</code>). When any of those libraries are updated, Trust Verification does not catch that. This applies equally to any processor that requires an external module to be loaded for it to function (e.g., IntuneUploader requires <code>requests</code> and <code>cryptography</code>).</li>
</ul>
<p>Finally, AutoPkg allows you to run one or more processors before or after the recipe by using the <code>--pre</code> and or <code>--post</code> options for the <code>run</code> verb. If you use a processor that is not already in the recipe being run, it will not be checked by the trust verification mechanism. Nathaniel Strauss <a href="https://nwstrauss.com/posts/2024-06-19-autopkg-processor-security/" target="_blank">wrote in detail about this in a recent blog post</a> and shared a technique (‚Äúvendoring‚Äù) that allows you to use processors in that context more securely. Along the same lines, recipe overrides generally don‚Äôt have a <code>Process</code> dictionary, but they absolutely can because they are a child recipe. Any processor steps you add to an override will not be scrutinized by the trust verification process.</p>
<h3>One More Thing‚Ä¶</h3>
<p>The final security consideration I want to highlight is a malicious actor modifying the code or recipes on the computer you are using to run AutoPkg. If malware (or even the practical joker in your office) changes anything prior to a run, only the changes covered by Trust Verification will be captured (and that‚Äôs only if the AutoPkg preferences are in tact). This is where people using ephemeral runners (e.g., CI/CD) have an advantage, as they are always loading from source. You should consider the threat of malware on your AutoPkg runner in the same way as you do any other Mac you support.</p>
<h3>Trust But Verify</h3>
<p>AutoPkg‚Äôs Trust Verification and the scrutiny of the AutoPkg maintainers takes care of much of what AutoPkg users need to ensure that AutoPkg is a secure tool to use. But the Admin running this versatile tool needs to be conscious of what they have to take care of themselves. Hopefully this article will help people understand where to put their focus in this regard.</p>
<p><cite>Thanks to Graham Pugh for helping make this post more complete.</cite></p>
<hr />
<p id="foot1">[1] If you want to more about <em>why</em> this was implemented, check out any of Elliot Jordan‚Äôs talks from that time on <a href="https://www.elliotjordan.com/talks/" target="_blank">How (Not) To Do Bad Things With AutoPkg</a>. <a href="#ref1">[Return to main text]</a></p>
<p id="foot2">[2] Anything you store alongside the AutoPkg code is not covered by Trust Verification. The old JSSImporter processors were ‚Äúsideloaded‚Äù into the AutoPkg code because they pre-dated the syntax for calling shared processors. While I‚Äôm not aware of anyone adding things to the AutoPkg code this way any more, there is nothing magic in AutoPkg that recognizes stuff that is unexpected in <code>/Library/AutoPkg</code>. <a href="#ref2">[Return to main text]</a></p>
<p id="foot3">[3] If you are running a recipe directly rather than using an override, you will be notified that there is ‚ÄúNo trust information present‚Äù, regardless of whether the recipe has changed or not. <a href="#ref3">[Return to main text]</a></p>
<p id="foot4">[4] If you want to do a run test of the updated recipe, you can use the <code>--ignore-parent-trust-verification-errors</code> option to turn off Trust Verification for just that run. I use that regularly when I am writing a new recipe or updating an old one. I have a shell alias that includes that option for me for ease of typing: <code>aprt='autopkg run -vv --ignore-parent-trust-verification-errors'</code>. (Level 2 verbosity is added because I‚Äôm always using this in a testing context.) <a href="#ref4">[Return to main text]</a></p>