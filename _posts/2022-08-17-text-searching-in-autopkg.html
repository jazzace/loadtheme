---
layout: post
title: ðŸ“¦ Text Searching in AutoPkg
---
<p>AutoPkg download recipes commonly use one of four methods to determine the URL to supply to URLDownloader:</p>
<ol>
<li>Use a static link provided by the developer (which may then redirect),</li>
<li>Obtain the link from some sort of feed (e.g., GitHubReleasesInfoProvider, SparkleUpdateInfoProvider),</li>
<li>Use/write a custom processor specifically for that vendor or title (e.g., <a href="https://github.com/autopkg/recipes/blob/master/Mozilla/MozillaURLProvider.py" target="_blank">MozillaURLProvider</a>, <a href="https://github.com/autopkg/n8felton-recipes/blob/master/SharedProcessors/AppleSupportDownloadInfoProvider.py" target="_blank">AppleSupportDownloadInfoProvider</a>), or</li>
<li>Scrape the URL from a web page using URLTextSearcher.</li>
</ol>
<p>That list is arguably in priority order. Yet there are many, many recipes where URLTextSearcher is the chosen solution. Personally, I know the ins and outs of HTML much better than Python, so I became familiar with URLTextSearcher very quickly. What I love about that particular processor is that it leverages the power of regular expressions for searching and allows you to name the output variable for the string that you find with your regular expression.</p>
<p>I recently had a situation where one of my download recipes was not behaving as intended, likely due to a change in the headers on the vendorâ€™s server. I was providing URLDownloader a static link, but since there was a redirect, I leveraged the <code>prefetch_filename</code> argument to have it fetch the proper filename for the download.<a href="#foot1" id="ref1"><sup>[1]</sup></a> After the change on the vendorâ€™s end, the <code>prefetch_filename</code> option was fetching a lot of extraneous information, leaving me with a filename of about 100 characters in length. While I filed an AutoPkg issue for this (<a href="https://github.com/autopkg/autopkg/issues/818" target="_blank">#818</a>), I still needed to work around it for now. The desired filename was a subset of the filename fetched by the <code>prefetch_filename</code> option, so my mind immediately went to regular expressions.</p>
<p>While there are other custom processors out there that can manipulate filenames (e.g., <a href="https://github.com/autopkg/homebysix-recipes/blob/master/FindAndReplace/FindAndReplace.py" target="_blank">FindAndReplace</a>), URLTextSearcher had the features I really wanted. The problem was that it only searches the contents of a file it downloads,<a href="#foot2" id="ref2"><sup>[2]</sup></a> not a filename. So rather than reinvent the wheel, I decided to build a custom processor based on URLTextSearcher. I took its code and eliminated all the download functionality. I then changed it so that the text to be searched would be whatever you assigned to the variable <code>text_in</code> rather than a file. I uncreatively named this processor <a href="https://github.com/autopkg/jazzace-recipes/blob/master/JazzAce/TextSearcher.py" target="_blank">TextSearcher</a>.</p>
<p>For the specific recipe I was dealing with, <code>%pathname%</code> was a good choice for the value of <code>text_in</code>, since it contained the filename I wanted to extract. Rather than construct a regular expression to extract the entire filename, however, I opted to grab the version number from the filename and assign that value to the variable <code>version</code>, since renaming the installer <code>%NAME%-%version%.pkg</code> was very similar to what the vendor was using and met my internal needs. (Lazily, the regular expression was also much easier to construct this way.) Problem solved!</p>
<p>I wasnâ€™t going to write about this, thinking the case was too obscure or could be solved another way. But then, a possible use for this processor by someone else <a href="https://macadmins.slack.com/archives/C056155B4/p1659973008506019" target="_blank">appeared in the MacAdmins Slack</a>. In their case, Java was involved and the version info they wanted was reliably contained in a particular .jar filename within the app bundle. Hence this blog post.</p>
<p>If you have a use for TextSearcher, you can call it using the following shared processor syntax: <code>com.github.jazzace.processors/TextSearcher</code>. You can see a <a href="https://github.com/autopkg/jazzace-recipes/blob/master/Microsoft/MicrosoftMacProductFWLink.pkg.recipe" target="_blank">recipe that uses it in my repo</a>.</p>
<hr/>
<p id="foot1">[1] AutoPkgâ€™s default behaviour is to take the part of the URL after the final slash of the original request prior to any redirect. You can also give your download an arbitrary name by setting the processorâ€™s <code>filename</code> Input Variable (e.g., to <code>%NAME%.dmg</code>, <code>%NAME%.pkg</code>). <a href="#ref1">[Return to main text]</a></p>
<p id="foot2">[2] Pro Tip: You can provide URLTextSearcher a <code>file:///</code> URL if you wish to search the contents of a file on the local system, even one you had downloaded earlier in the recipe chain. <a href="#ref2">[Return to main text]</a></p>